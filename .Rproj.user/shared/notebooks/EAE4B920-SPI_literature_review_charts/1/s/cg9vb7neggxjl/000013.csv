"0","#| label: countrytab"
"0",""
"0","#arrange table and format"
"0","index_disp <- spi_index_df %>%"
"0","  ungroup() %>%"
"0","  filter(date==end_date) %>%"
"0","  arrange(-SPI.INDEX) %>%"
"0","  mutate(across(starts_with('SPI.INDEX'),~1*.),"
"0","         across(starts_with('SPI.INDEX'),round,1)) %>%"
"0","  select(country, iso3c, date, starts_with('SPI.INDEX'))"
"0",""
"0","#colors"
"0",""
"0","col_palette <- c(""#2ec4b6"", ""#acece7"", ""#f1dc76"",  ""#ffbf69"",""#ff9f1c""   )"
"0",""
"0","col_palette2 <- c(""#2ec4b6"",  ""#f1dc76"", ""#ff9f1c"" )"
"0",""
"0","#make the table"
"0","index_tab <- index_disp %>%"
"0","  filter(date==end_date) %>%"
"0","  select(country, SPI.INDEX,SPI.INDEX.PIL1,SPI.INDEX.PIL2,SPI.INDEX.PIL3,SPI.INDEX.PIL4,SPI.INDEX.PIL5) "
"0",""
"0"," #calculate the breaks for the color coding"
"0","        brks <- quantile(index_tab$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks <- append(0,brks)"
"0","        brks <- append(brks,100)"
"0",""
"0","        brks1 <- quantile(index_tab$SPI.INDEX.PIL1, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks1 <- append(0,brks1)"
"0","        if (max(brks1)<100) brks1 <- append(brks1,100)"
"0","        "
"0","        brks2 <- quantile(index_tab$SPI.INDEX.PIL2, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks2 <- append(0,brks2)"
"0","        if (max(brks2)<100) brks2 <- append(brks2,100)"
"0","        "
"0","        brks3 <- quantile(index_tab$SPI.INDEX.PIL3, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks3 <- append(0,brks3)"
"0","        if (max(brks3)<100) brks3 <- append(brks3,100)"
"0","        "
"0","        brks4 <- quantile(index_tab$SPI.INDEX.PIL4, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks4 <- append(0,brks4)"
"0","        if (max(brks4)<100) brks4 <- append(brks4,100)"
"0","        "
"0","        brks5 <- quantile(index_tab$SPI.INDEX.PIL5, probs=c(1,2,3,4)/5,na.rm=T)"
"0","        brks5 <- append(0,brks5)"
"0","        if (max(brks5)<100) brks5 <- append(brks5,100)"
"0","        "
"0",""
"0","      #make nice looking"
"0","      index_tab <- index_tab %>%"
"0","        flextable() %>%"
"0","        # add_header_lines('SPI overall score in end_date and Pillar Scores.') %>%"
"0","        set_header_labels(values=list("
"0","                             country=""Country"","
"0","                             SPI.INDEX=""SPI overall score"","
"0","                             SPI.INDEX.PIL1=""Pillar 1: Data Use"","
"0","                             SPI.INDEX.PIL2=""Pillar 2: Data Services"","
"0","                             SPI.INDEX.PIL3=""Pillar 3: Data Products "","
"0","                             SPI.INDEX.PIL4=""Pillar 4: Data Sources"","
"0","                             SPI.INDEX.PIL5=""Pillar 5: Data Infrastructure"""
"0","                                         )) %>%"
"0","          bg(j = c('SPI.INDEX'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%"
"0","          bg(j = c('SPI.INDEX.PIL1'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%"
"0","          bg(j = c('SPI.INDEX.PIL2'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%"
"0","          bg(j = c('SPI.INDEX.PIL3'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%"
"0","          bg(j = c('SPI.INDEX.PIL4'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%"
"0","          bg(j = c('SPI.INDEX.PIL5'),"
"0","             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))"
"0",""
"0",""
"0","FitFlextableToPage(index_tab)"
