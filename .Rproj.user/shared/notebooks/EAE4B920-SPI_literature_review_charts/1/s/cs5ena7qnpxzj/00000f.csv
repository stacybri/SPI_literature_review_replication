"0","#| label: fun"
"0",""
"0","#ggplot theme"
"0","theme_spi <- function () { "
"0","    theme_bw() %+replace%"
"0","    theme("
"0","      plot.caption = element_text(hjust = 0),"
"0","      plot.title=element_blank() #remove all titles from plots (sometimes we may need to bring title outside plot)"
"0","    )"
"0","}"
"0","# define stle for ggplot based on BBC plotting styles"
"0","bbc_style <- function() {"
"0","  font <- ""Helvetica"""
"0","  "
"0","  ggplot2::theme("
"0","    "
"0","    #Text format:"
"0","    #This sets the font, size, type and colour of text for the chart's title"
"0","    plot.title = ggplot2::element_text(family=font,"
"0","                                       size=32,"
"0","                                       face=""bold"","
"0","                                       color=""#222222""),"
"0","    #This sets the font, size, type and colour of text for the chart's subtitle, as well as setting a margin between the title and the subtitle"
"0","    plot.subtitle = ggplot2::element_text(family=font,"
"0","                                          size=20,"
"0","                                          margin=ggplot2::margin(9,0,9,0)),"
"0","    plot.caption = ggplot2::element_blank(),"
"0","    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function"
"0","    "
"0","    #Legend format"
"0","    #This sets the position and alignment of the legend, removes a title and backround for it and sets the requirements for any text within the legend. The legend may often need some more manual tweaking when it comes to its exact position based on the plot coordinates."
"0","    legend.position = ""top"","
"0","    legend.text.align = 0,"
"0","    legend.background = ggplot2::element_blank(),"
"0","    legend.title = ggplot2::element_blank(),"
"0","    legend.key = ggplot2::element_blank(),"
"0","    legend.text = ggplot2::element_text(family=font,"
"0","                                        size=18,"
"0","                                        color=""#222222""),"
"0","    "
"0","    #Axis format"
"0","    #This sets the text font, size and colour for the axis test, as well as setting the margins and removes lines and ticks. In some cases, axis lines and axis ticks are things we would want to have in the chart - the cookbook shows examples of how to do so."
"0","    axis.title = ggplot2::element_blank(),"
"0","    axis.text = ggplot2::element_text(family=font,"
"0","                                      size=14,"
"0","                                      color=""#222222""),"
"0","    axis.text.x = ggplot2::element_text(margin=ggplot2::margin(5, b = 10)),"
"0","    axis.ticks = ggplot2::element_blank(),"
"0","    axis.line = ggplot2::element_blank(),"
"0","    "
"0","    #Grid lines"
"0","    #This removes all minor gridlines and adds major y gridlines. In many cases you will want to change this to remove y gridlines and add x gridlines. The cookbook shows you examples for doing so"
"0","    panel.grid.minor = ggplot2::element_blank(),"
"0","    panel.grid.major.x = ggplot2::element_line(color=""#cbcbcb""),"
"0","    panel.grid.major.y = ggplot2::element_blank(),"
"0","    "
"0","    #Blank background"
"0","    #This sets the panel background as blank, removing the standard grey ggplot background colour from the plot"
"0","    panel.background = ggplot2::element_blank(),"
"0","    "
"0","    #Strip background (#This sets the panel background for facet-wrapped plots to white, removing the standard grey ggplot background colour and sets the title size of the facet-wrap title to font size 22)"
"0","    strip.background = ggplot2::element_rect(fill=""white""),"
"0","    strip.text = ggplot2::element_text(size  = 22,  hjust = 0)"
"0","  )"
"0","}"
"0",""
"0","geom_curve_polar <- function(...) {"
"0","  layer <- geom_curve(...)"
"0","  new_layer <- ggproto(NULL, layer)"
"0","  old_geom <- new_layer$geom"
"0","  geom <- ggproto("
"0","    NULL, old_geom,"
"0","    draw_panel = function(data, panel_params, coord, "
"0","                          curvature = 0.5, angle = 90, ncp = 5,"
"0","                          arrow = NULL, arrow.fill = NULL,"
"0","                          lineend = ""butt"", linejoin = ""round"","
"0","                          na.rm = FALSE) {"
"0","      data <- ggplot2:::remove_missing("
"0","        data, na.rm = na.rm, c(""x"", ""y"", ""xend"", ""yend"", "
"0","                               ""linetype"", ""size"", ""shape"")"
"0","      )"
"0","      if (ggplot2:::empty(data)) {"
"0","        return(zeroGrob())"
"0","      }"
"0","      coords <- coord$transform(data, panel_params)"
"0","      ends <- transform(data, x = xend, y = yend)"
"0","      ends <- coord$transform(ends, panel_params)"
"0","      "
"0","      arrow.fill <- if (!is.null(arrow.fill)) arrow.fill else coords$colour"
"0","      return(grid::curveGrob("
"0","        coords$x, coords$y, ends$x, ends$y,"
"0","        default.units = ""native"", gp = grid::gpar("
"0","          col = alpha(coords$colour, coords$alpha),"
"0","          fill = alpha(arrow.fill, coords$alpha),"
"0","          lwd = coords$size * .pt,"
"0","          lty = coords$linetype,"
"0","          lineend = lineend,"
"0","          linejoin = linejoin"
"0","        ),"
"0","        curvature = curvature, angle = angle, ncp = ncp,"
"0","        square = FALSE, squareShape = 1, inflect = FALSE, open = TRUE,"
"0","        arrow = arrow"
"0","      ))"
"0","      "
"0","    }"
"0","  )"
"0","  new_layer$geom <- geom"
"0","  return(new_layer)"
"0","}"
"0",""
"0","gg_bars <- function(z) {"
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#ff595e"",""#ffca3a"",""#8ac926"",""#1982c4"",""#6a4c93"")  "
"0","  names(col_pal) <- c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10))"
"0","  "
"0","  "
"0","  z <- z"
"0","  z <- na.omit(z)"
"0","  x <- factor(x=c(1,2,3,4,5), labels=c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10)))"
"0","  z <- data.frame(x = x, z = z, w = z < 0)"
"0","  ggplot(z, aes(x = x, y = z)) +"
"0","    geom_col(show.legend = FALSE, fill='#7A8776') +"
"0","    geom_text(aes(label=scales::percent(z)), nudge_y = .01, size=5) +"
"0","    geom_hline(aes(yintercept=0.2)) +"
"0","    bbc_style() +"
"0","    expand_limits(y=c(0,1)) +"
"0","    theme("
"0","      axis.text.x = element_text()"
"0","    ) +"
"0","    annotate('text', x=1.1, y=0.5, label=str_wrap(""Line of Equal Weight"",15)) +"
"0","    geom_curve(aes(x=0.9,y=0.4, xend=1.2,yend=0.2), curvature=-0.2) "
"0","}"
"0",""
"0","gg_bars2 <- function(z) {"
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#ff595e"",""#ffca3a"",""#8ac926"",""#1982c4"",""#6a4c93"")  "
"0","  names(col_pal) <- c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10))"
"0","  "
"0","  "
"0","  z <- z"
"0","  z <- na.omit(z)"
"0","  x <- factor(x=c(1,2,3,4,5), labels=c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10)))"
"0","  z <- data.frame(x = x, z = z, w = z < 0)"
"0","  ggplot(z, aes(x = x, y = z)) +"
"0","    geom_col(show.legend = FALSE, fill='#7A8776') +"
"0","    geom_text(aes(label=scales::percent(z)), nudge_y = .01, size=5) +"
"0","    geom_hline(aes(yintercept=0.2)) +"
"0","    bbc_style() +"
"0","    expand_limits(y=c(0,1)) +"
"0","    theme("
"0","      axis.text.x = element_text()"
"0","    ) +"
"0","    annotate('text', x=1.1, y=0.5, label=str_wrap(""Line of Equal Weight"",15)) +"
"0","    geom_curve(aes(x=0.9,y=0.4, xend=1.2,yend=0.2), curvature=-0.2) "
"0","}"
"0",""
"0","gg_polar <- function(z) {"
"0","  "
"0","    #set color pallete"
"0","  col_pal <- c(""#ff595e"",""#ffca3a"",""#8ac926"",""#1982c4"",""#6a4c93"")  "
"0","  names(col_pal) <- c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10))"
"0","  "
"0","  z <- z"
"0","  z <- na.omit(z)"
"0","  x <- factor(x=c(1,2,3,4,5), labels=c(str_wrap(""Data Use"",10), str_wrap(""Data Services"",10), str_wrap(""Data Products"",10), str_wrap(""Data Sources"",10), str_wrap(""Data Infrastructure"",10)))"
"0","  z <- data.frame(x = x, z = z, w = z < 0)"
"0","  ggplot(z, aes(x = x, y = z, fill = x)) +"
"0","    geom_col(show.legend = FALSE) +"
"0","    geom_text(aes(y=0.35,label=scales::percent(z)), nudge_y = .01) +"
"0","    geom_text(aes(y=0.6,label=x), nudge_y = .01, fontface=""bold"", font=""TT Arial"") +"
"0","    geom_hline(aes(yintercept=0.2)) + "
"0","    #geom_hline(aes(yintercept=0.4)) + "
"0","    #geom_hline(aes(yintercept=0.8)) + "
"0","    geom_vline(aes(xintercept=0.5)) +"
"0","    geom_vline(aes(xintercept=1.5)) +"
"0","    geom_vline(aes(xintercept=2.5)) +"
"0","    geom_vline(aes(xintercept=3.5)) +"
"0","    geom_vline(aes(xintercept=4.5)) +"
"0","      scale_fill_manual("
"0","        values=col_pal,"
"0","        na.value='grey'"
"0","      ) +    "
"0","    theme_void() +"
"0","    expand_limits(y=c(0,1)) +"
"0","    theme("
"0","      axis.text.y = element_blank(),"
"0","    #Text format:"
"0","    #This sets the font, size, type and colour of text for the chart's title"
"0","    plot.title = ggplot2::element_text(family=""TT Arial"","
"0","                                       size=20,"
"0","                                       face=""bold"","
"0","                                       color=""#222222""),"
"0","    #This sets the font, size, type and colour of text for the chart's subtitle, as well as setting a margin between the title and the subtitle"
"0","    plot.subtitle = ggplot2::element_text(family=""TT Arial"","
"0","                                          size=22,"
"0","                                          margin=ggplot2::margin(9,0,9,0)),"
"0","    plot.caption = ggplot2::element_blank(),"
"0","    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function"
"0","    "
"0","    #Legend format"
"0","    #This sets the position and alignment of the legend, removes a title and backround for it and sets the requirements for any text within the legend. The legend may often need some more manual tweaking when it comes to its exact position based on the plot coordinates."
"0","    legend.position = ""top"","
"0","    legend.text.align = 0,"
"0","    legend.background = ggplot2::element_blank(),"
"0","    legend.title = ggplot2::element_blank(),"
"0","    legend.key = ggplot2::element_blank(),"
"0","    legend.text = ggplot2::element_text(family=""TT Arial"","
"0","                                        size=18,"
"0","                                        color=""#222222""),"
"0","    "
"0","    #Axis format"
"0","    #This sets the text font, size and colour for the axis test, as well as setting the margins and removes lines and ticks. In some cases, axis lines and axis ticks are things we would want to have in the chart - the cookbook shows examples of how to do so."
"0","    axis.title = ggplot2::element_blank(),"
"0","    axis.text = ggplot2::element_text(family=""TT Arial"","
"0","                                      size=8,"
"0","                                      color=""#222222""),"
"0","    axis.text.x = ggplot2::element_blank(),"
"0","    axis.ticks = ggplot2::element_blank(),"
"0","    axis.line = ggplot2::element_blank(),"
"0","    "
"0","    #Grid lines"
"0","    #This removes all minor gridlines and adds major y gridlines. In many cases you will want to change this to remove y gridlines and add x gridlines. The cookbook shows you examples for doing so"
"0","    panel.grid.minor = ggplot2::element_blank(),"
"0","    #panel.grid.major.x = ggplot2::element_line(color=""#cbcbcb""),"
"0","    panel.grid.major.y = ggplot2::element_blank(),"
"0","    "
"0","    #Blank background"
"0","    #This sets the panel background as blank, removing the standard grey ggplot background colour from the plot"
"0","    panel.background = ggplot2::element_blank(),"
"0","    "
"0","    #Strip background (#This sets the panel background for facet-wrapped plots to white, removing the standard grey ggplot background colour and sets the title size of the facet-wrap title to font size 22)"
"0","    strip.background = ggplot2::element_rect(fill=""white""),"
"0","    strip.text = ggplot2::element_text(size  = 22,  hjust = 0)      "
"0","    ) + "
"0","    coord_polar() +"
"0","    # annotate('text', x=1.5, y=0.6, label=str_wrap(""Line of Equal Weight"",10)) +"
"0","    # geom_curve_polar(aes(x=1.4,y=0.5, xend=1.6,yend=0.2), curvature=-0.2,"
"0","    #                  arrow = arrow(length = unit(0.03, ""npc"")))     +      # Zoom in & cut off values"
"0","   ylim(0, 0.65)"
"0",""
"0","}"
"0",""
"0","load(paste0(raw_dir, '/misc/maps.Rdata'))"
"0","standard_crop_wintri <- function() {"
"0","  l <- list("
"0","    left=-12000000, right=16396891,"
"0","    top=9400000, bottom=-6500000"
"0","  )"
"0","  l$xlim <- c(l$left, l$right)"
"0","  l$ylim <- c(l$bottom, l$top)"
"0","  l"
"0","}"
"0","country_metadata <- wbstats::wbcountries()"
"2","Warning: `wbcountries()` was deprecated in wbstats 1.0.0.
Please use `wb_countries()` instead."
"0","spi_mapper <- function(data, indicator, title) {"
"0","  "
"0"," indicator<-indicator"
"0","   map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(iso3c, date, data_available, weights) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     "
"0","  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)"
"0","  "
"0","  SPI_map <- map_df %>%"
"0","    mutate(spi_groups=case_when("
"0","      between(data_available, spi_groups_quantiles[4],100) ~ ""Top 20%"","
"0","      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ ""4th Quintile"","
"0","      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","      between(data_available, 0,spi_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      "
"0","    )) %>%"
"0","    mutate(spi_groups=factor(spi_groups, "
"0","                             levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )))  "
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#2ec4b6"",""#acece7"",""#f1dc76"",""#ffbf69"",""#ff9f1c"")  "
"0","  names(col_pal) <- c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )"
"0","  "
"0","  p1<-ggplot() +"
"0","    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + "
"0","    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = ""grey80"") + "
"0","    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = ""white"")  +"
"0","    geom_path(data = maps$boundaries,"
"0","              aes(long, lat, group = group),"
"0","              color = ""white"","
"0","              size = 0.4,"
"0","              lineend = maps$boundaries$lineend,"
"0","              linetype = maps$boundaries$linetype) +"
"0","    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +"
"0","    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +"
"0","    scale_fill_manual("
"0","      name='SPI Score',"
"0","      values=col_pal,"
"0","      na.value='grey'"
"0","    ) +"
"0","    coord_equal() +"
"0","    theme_map(base_size=12) +"
"0","    labs("
"0","      title=str_wrap(title,100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators'"
"0","    ) +"
"0","    theme("
"0","      text=element_text(size=14)"
"0","    )"
"0"," print(p1)"
"0","}"
"0","spi_charts  <- function(data, indicator, title) {"
"0","  "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  #add histogram by region "
"0","  p2 <- map_df %>%"
"0","    group_by(region) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=region, fill=region)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Region', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","    theme("
"0","      text=element_text(size=14)"
"0","    )"
"0","  "
"0","  #by income"
"0","    income <- c(""Low income"", ""Lower middle income"",""Upper middle income"",""High income"")"
"0","    p3 <- map_df %>%"
"0","    group_by(income) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=wtd.mean(data_available, weights=weights, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Income', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = income) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","    theme("
"0","      text=element_text(size=14)"
"0","    )"
"0","    "
"0","  # #add line graph over time"
"0","  p4 <- get(data)  %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    # right_join(spi_df_empty) %>%"
"0","    group_by( date) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%"
"0","    mutate(`SPI Score`=mean(data_available, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ungroup() %>%"
"0","    ggplot(aes(y=`SPI Score`, x=date)) +"
"0","      geom_point() +"
"0","      geom_line(fill='blue') +"
"0","      # geom_text_repel(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Date', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.'"
"0","      ) +"
"0","    "
"0","      expand_limits(y=c(0,100)) +"
"0","      theme_spi() +"
"0","    theme("
"0","      text=element_text(size=14)"
"0","    )"
"0","      "
"0"," (p2 / p3) "
"0","    "
"0","}"
"0","spi_country_charts  <- function(data, indicator, title) {"
"0","  "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    filter(region!=""Aggregates"") %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)"
"0","  "
"0","  SPI_map <- map_df %>%"
"0","    mutate(spi_groups=case_when("
"0","      between(data_available, spi_groups_quantiles[4],100) ~ ""Top 20%"","
"0","      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ ""4th Quintile"","
"0","      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ ""3rd Quintile"","
"0","      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ ""2nd Quintile"","
"0","      between(data_available, 0,spi_groups_quantiles[1]) ~ ""Bottom 20%"""
"0","      "
"0","    )) %>%"
"0","    mutate(spi_groups=factor(spi_groups, "
"0","                             levels=c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )))  "
"0","  "
"0","  #set color pallete"
"0","  col_pal <- c(""#2ec4b6"",""#acece7"",""#f1dc76"",""#ffbf69"",""#ff9f1c"")  "
"0","  names(col_pal) <- c(""Top 20%"",""4th Quintile"",""3rd Quintile"",""2nd Quintile"",""Bottom 20%"" )"
"0","  "
"0","  p2_alt <- SPI_map %>%"
"0","    ungroup() %>%"
"0","    ggplot(aes(x=data_available, y=region, color=spi_groups)) +"
"0","      geom_point() +"
"0","      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Country', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      xlab('Score') +"
"0","      expand_limits(x=c(0,100)) +"
"0","      scale_color_manual("
"0","        name='SPI Score',"
"0","        values=col_pal,"
"0","        na.value='grey'"
"0","      ) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14)"
"0","            ) "
"0","p2_alt"
"0","}"
"0","income_charts <- function(data, indicator, title) { "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  income <- c(""Low income"", ""Lower middle income"",""Upper middle income"",""High income"")"
"0","  p2_alt3 <- map_df %>%"
"0","    ungroup() %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=(data_available),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=income, color=income)) +"
"0","      geom_point() +"
"0","      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Income', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = income) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14) )"
"0","   "
"0","p2_alt3 "
"0","  "
"0"," "
"0","}"
"0","spi_income_aggregates <- function(data, indicator, title) {"
"0","   indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))   "
"0","  "
"0","    income <- c(""Low income"", ""Lower middle income"",""Upper middle income"",""High income"")"
"0","    p3 <- map_df %>%"
"0","    group_by(income) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=wtd.mean(data_available, weights=weights, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Income', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = income) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","    theme("
"0","      text=element_text(size=14)"
"0","    )"
"0","    "
"0","    p3"
"0","}"
"0","lending_charts <- function(data, indicator, title) { "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  lending_list <- c(""Not classified"", ""IBRD"", ""Blend"", ""IDA"" )"
"0","  "
"0","  p2_alt3 <- map_df %>%"
"0","    ungroup() %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=(data_available),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=lending, color=lending)) +"
"0","      geom_point() +"
"0","      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Lending Status', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = lending_list) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14) )"
"0","   "
"0","p2_alt3 "
"0","  "
"0"," "
"0","}"
"0","lending_chart_aggregate <- function(data, indicator, title) { "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  lending_list <- c(""Not classified"", ""IBRD"", ""Blend"", ""IDA"" )"
"0","  "
"0","  "
"0","  p2_alt3 <- map_df %>%"
"0","    group_by(lending) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=lending, fill=lending)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Lending Status', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = lending_list) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14) )"
"0","   "
"0","p2_alt3 "
"0","  "
"0"," "
"0","}"
"0","fcs_charts <- function(data, indicator, title) { "
"0","  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)"
"0","  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )"
"0","  "
"0","  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',"
"0","                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')"
"0","  "
"0","  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',"
"0","                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',"
"0","                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')"
"0","  "
"0","  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')"
"0","  "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations"
"0","      country %in% high_intensity_conflict ~ ""FCS country"","
"0","      country %in% medium_intensity_conflict ~ ""FCS country"","
"0","      country %in% high_institutional_social_fragility ~ ""FCS country"","
"0","      country %in% small_states ~ ""FCS country"","
"0","      TRUE ~ ""Non-FCS country"""
"0","    )) %>%"
"0","    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations"
"0","      country %in% high_intensity_conflict ~ ""High-Intensity Conflict"","
"0","      country %in% medium_intensity_conflict ~ ""Medium-Intensity Conflict"","
"0","      country %in% high_institutional_social_fragility ~ ""High Institutional & Social Fragility"","
"0","      country %in% small_states ~ ""Small States"","
"0","      TRUE ~ ""Non-FCS country"""
"0","    )) %>%"
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country,fcs,fcs_detail, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  fcs_list <- c(""High-Intensity Conflict"", ""Medium-Intensity Conflict"",""High Institutional & Social Fragility"",""Small States"",""Non-FCS country"")"
"0","  fcs_list <- c(""FCS country"",""Non-FCS country"")"
"0","  p2_alt2 <- map_df %>%"
"0","    ungroup() %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=(data_available),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=fcs, color=fcs)) +"
"0","      geom_point() +"
"0","      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = fcs_list) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14)) "
"0","   "
"0","p2_alt2 "
"0","  "
"0"," "
"0","}"
"0","fcs_chart_aggregate <- function(data, indicator, title) { "
"0","  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)"
"0","  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )"
"0","  "
"0","  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',"
"0","                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')"
"0","  "
"0","  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',"
"0","                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',"
"0","                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')"
"0","  "
"0","  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')"
"0","  "
"0"," indicator<-indicator"
"0","  map_df <- get(data) %>%"
"0","    filter(date==max(date, na.rm=T)) %>%"
"0","    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data."
"0","    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations"
"0","      country %in% high_intensity_conflict ~ ""FCS country"","
"0","      country %in% medium_intensity_conflict ~ ""FCS country"","
"0","      country %in% high_institutional_social_fragility ~ ""FCS country"","
"0","      country %in% small_states ~ ""FCS country"","
"0","      TRUE ~ ""Non-FCS country"""
"0","    )) %>%"
"0","    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations"
"0","      country %in% high_intensity_conflict ~ ""High-Intensity Conflict"","
"0","      country %in% medium_intensity_conflict ~ ""Medium-Intensity Conflict"","
"0","      country %in% high_institutional_social_fragility ~ ""High Institutional & Social Fragility"","
"0","      country %in% small_states ~ ""Small States"","
"0","      TRUE ~ ""Non-FCS country"""
"0","    )) %>%"
"0","    group_by( country) %>%"
"0","    #summarise(across(!! indicator,last)) %>%"
"0","    rename(data_available=!! indicator) %>%"
"0","    select(country,fcs,fcs_detail, date, data_available, weights ) %>%"
"0","    right_join(country_metadata) %>%"
"0","    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    "
"0","  "
"0","  fcs_list <- c(""High-Intensity Conflict"", ""Medium-Intensity Conflict"",""High Institutional & Social Fragility"",""Small States"",""Non-FCS country"")"
"0","  fcs_list <- c(""FCS country"",""Non-FCS country"")"
"0","  p2_alt2 <- map_df %>%"
"0","    group_by(fcs) %>%"
"0","    filter(region!='Aggregates') %>%"
"0","    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),"
"0","           Label = paste(round(`SPI Score`,0))) %>%"
"0","    ggplot(aes(x=`SPI Score`, y=fcs, fill=fcs)) +"
"0","      geom_bar(stat=""identity"",position='dodge') +"
"0","      geom_text(aes(label=Label)) +"
"0","      labs("
"0","      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep="" - ""),100),"
"0","      caption = 'Source: World Bank. Statistical Performance Indicators.',"
"0","      subtitle= 'Based on data for 2022 or the latest year available'"
"0","      ) +"
"0","      scale_y_discrete(limits = fcs_list) +"
"0","      expand_limits(x=c(0,100)) +"
"0","      theme_spi() +"
"0","      theme(legend.position = 'top',"
"0","            text=element_text(size=14)) "
"0","  "
"0","  "
"0","  "
"0","p2_alt2 "
"0","  "
"0"," "
"0","}"
"0","FitFlextableToPage <- function(ft, pgwidth = 6){"
"0","  ft_out <- ft %>% autofit()"
"0","  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))"
"0","  return(ft_out)"
"0","}"
"0","#add equations to plots"
"0","eq_plot_txt <- function(data, inp, var) {"
"0","  eq <- lm_robust(inp ~ var, data=data, se_type='HC2')"
"0","  coef <- round(coef(eq),1)"
"0","  std_err <- round(sqrt(diag(vcov(eq))),1)"
"0","  r_2<- round(summary(eq)$r.squared,2)"
"0","  sprintf("" y = %.1f + %.1f x, R<sup>2</sup> = %.2f <br> (%.1f) <span style='color:white'> %s</span> (%.1f) "", coef[1], coef[2], r_2[1], std_err[1],""s"", std_err[2])"
"0","  "
"0","}"
"0",""
